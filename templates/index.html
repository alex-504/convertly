<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convertly</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
  <section class="home">
    <div class="container">
        <nav>
          <a href="/">Home</a>
          <a href="https://patreon.com/alexandrevieira?utm_medium=unknown&utm_source=join_link&utm_campaign=creatorshare_creator&utm_content=copyLink">Support Our Page</a>
        </nav>
        <h1>Welcome to Convertly</h1>
        <p>File Conversion Service</p>

        <form id="upload-form" action="/upload" method="POST" enctype="multipart/form-data">
            <label for="file-upload">Choose File</label>
            <input id="file-upload" type="file" name="file">
            <p id="file-name" style="margin-top: 10px;"></p>
            <button id="submit-button" class="button-55 disabled-button" disabled>Upload</button>
        </form>

        <!-- Loader container -->
        <div class="loader-container">
          <div class="loader-bar" id="loader-bar">0%</div>
        </div>
        <div class="spinner" id="loading-spinner"></div>

        <!-- Modal for password input -->
        <div id="password-modal" class="modal">
            <div class="modal-content">
                <span id="close-modal" class="close">&times;</span>
                <h2>PDF Password Required</h2>
                <p>This file is encrypted. Please provide the password to proceed:</p>
                <input id="pdf-password" type="password" placeholder="Enter password">
                <button id="submit-password" class="button-55">Submit Password</button>
            </div>
        </div>
    </div>
  </section>

  <script>
    const uploadForm = document.getElementById('upload-form');
    const fileUpload = document.getElementById('file-upload');
    const submitButton = document.getElementById('submit-button');
    const loaderBar = document.getElementById('loader-bar');
    const passwordModal = document.getElementById('password-modal');
    const closeModal = document.getElementById('close-modal');
    const submitPasswordButton = document.getElementById('submit-password');
    const pdfPasswordInput = document.getElementById('pdf-password');
    let currentFilename = '';

    // File selection and validation
    fileUpload.addEventListener('change', function(event) {
        const fileName = event.target.files[0]?.name;
        const fileExtension = fileName.split('.').pop().toLowerCase();
        const allowedExtensions = ['pdf'];

        if (fileName && allowedExtensions.includes(fileExtension)) {
            document.getElementById('file-name').innerText = `Selected file: ${fileName}`;
            submitButton.disabled = false;
            submitButton.classList.remove('disabled-button');
            submitButton.classList.add('active-button');
        } else {
            document.getElementById('file-name').innerText = 'Invalid file type. Please upload a PDF.';
            submitButton.disabled = true;
            submitButton.classList.remove('active-button');
            submitButton.classList.add('disabled-button');
        }
    });

    // File upload and password modal logic
    uploadForm.addEventListener('submit', function(event) {
        event.preventDefault();

        const formData = new FormData(uploadForm);
        fetch('/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.encrypted) {
                currentFilename = data.filename;
                passwordModal.style.display = 'block'; // Show the modal
            } else {
                // Redirect to show the file and download link
                window.location.href = `/show_result/${data.filename}/${data.text_filename}`;
            }
        })
        .catch(error => console.error('Error:', error));
    });

    // Close the modal
    closeModal.addEventListener('click', function() {
        passwordModal.style.display = 'none';
    });

    // Submit password
    submitPasswordButton.addEventListener('click', function() {
        const password = pdfPasswordInput.value;
        fetch('/submit_password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ password: password, filename: currentFilename }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = `/show_result/${data.filename}/${data.text_filename}`;
            } else {
                alert('Password incorrect. Please try again.');
            }
        })
        .catch(error => console.error('Error:', error));
    });

    // Hide modal on outside click
    window.addEventListener('click', function(event) {
        if (event.target === passwordModal) {
            passwordModal.style.display = 'none';
        }
    });
  </script>
</body>
</html>